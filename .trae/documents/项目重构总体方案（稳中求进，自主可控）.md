# 项目重构总体方案（稳中求进，自主可控）

## 总体原则

- 坚持中国特色社会发展导向：以安全可控为前提，优先采用开源可替代与自研封装；避免对外部不可控服务形成单点依赖。
- 贯彻新发展理念：在创新与安全之间取得平衡，兼顾性能、绿色算力与可持续维护。
- 服务“两个一百年”战略：以长期可维护与可演进的架构为目标，建立标准化治理与度量体系。
- 四个意识与两个维护：建立严格的责任制与过程透明化，确保质量与安全底线不破。

## 组织与职责（专项工作组）

- 组织构成：技术架构负责人（总牵头）、前端负责人（Next.js/React）、后端与接口负责人（API Routes/安全）、测试与质量负责人、业务专家代表、运维/安全专家。
- 管理机制：RACI 明确（Responsible/Accountable/Consulted/Informed）；每周例会+风险清单更新；里程碑评审与验收门槛公开。
- 交付承诺：每阶段形成书面评估报告、风险缓解方案与验收数据；所有变更通过评审与灰度策略上线。

## 现状评估输出（基线与问题清单）

- 技术栈：Next.js 14 App Router + React 18 + TypeScript + Tailwind；API Routes 提供生成/导出/埋点/金融子域（如 `src/app/api/*`）。
- 分层结构：interfaces/application/domain/infrastructure/shared 清晰，具备指标、限流、RBAC、CSP/CSRF/CORS 等安全控制。
- 质量与测试：Vitest 单元测试、覆盖率阈值高；Playwright 以库方式用于渲染；依赖健康检查与 CI 完备。
- 初步问题清单（示例）：
    - 组件承担部分业务逻辑，易造成重渲染与耦合（如 `src/components/*`）。
    - 限流/幂等在无 Redis 时依赖本地缓存，集群一致性风险（`src/shared/lib/cache.ts`）。
    - CSP 在开发模式允许 `unsafe-eval`，需要确保生产更严格隔离（`next.config.js`）。
    - 性能基线与容量基线缺乏统一度量与持续回归。

## 风险与稳定性保障

- 变更冻结窗：每阶段前1周建立“功能冻结+灰度开关”，确保可随时回滚。
- 灰度/蓝绿：按路由与功能模块进行灰度发布，保留旧路径与数据契约（API 版本化）。
- 兼容性策略：新增接口以 `v2` 暂存，保留 `v1` 至验证完成；UI 变更启用特性旗标与用户分群。
- 回滚与应急：一键回滚脚本与操作手册，演练频次每月1次；错误预算门槛明确。

## 分阶段重构计划

- 阶段0（2周）：全面评估与基线建立
    - 依赖与架构巡检：生成依赖图与循环依赖报告；识别跨层耦合与大组件热点。
    - 基线度量：建立性能（TTFB、FCP、LCP）、稳定性（错误率/超时率）、容量（QPS、P95/P99）与资源（CPU/内存）基线。
    - 安全审计：CSP/CSRF/CORS、RBAC、限流与幂等审查；生成初始风险清单。
- 阶段1（3–4周）：架构固化与边界下沉
    - 前端：拆分重组件为纯展示与容器组件；减少 Context 级重渲染；统一主题与动画的可配置化（`tailwind.config.ts`）。
    - 应用层：将业务逻辑下沉至 `application/usecases`，组件仅通过 hooks 调用用例与接口。
    - 接口层：API Routes 统一入参校验（`zod`）、幂等键与统一错误模型；输出稳定契约与版本化。
    - 依赖治理：按 `dependency-cruiser` 结果修复跨层耦合，确保 `domain` 无 UI 依赖。
- 阶段2（2–3周）：安全与自主可控加强
    - CSP 与安全头：生产环境移除非必要来源，最小化 `connect-src`；细化 `Permissions-Policy`。
    - 认证与授权：规范 `Authorization` 解析与 RBAC 动作集合；审计所有金融子域接口的权限路径。
    - 供应链安全：锁定 `package-lock.json`；开源依赖 SCA 报告；内部镜像与离线构建预案。
    - 可选增强：将限流与幂等迁移至 Redis 提供一致性（保留本地降级）。
- 阶段3（2–3周）：性能优化与资源效率
    - 前端：路由级代码拆分、图片优化（`Sharp`）、Tailwind tree-shaking；减少不必要的客户端组件。
    - 服务端：缓存层（LRU/Redis）策略与 TTL 梳理；热点路径压测与优化。
    - 指标与告警：统一埋点与指标上报，建立 SLO/SLA 与报警规则。
- 阶段4（2周）：测试体系完善与回归
    - 单元测试：覆盖关键用例与控制器达到或超过既定阈值。
    - 集成测试：API 路由黑盒测试与契约测试；模拟鉴权与限流场景。
    - 压力测试：选型 `k6/Artillery`（本地/CI 可运行），形成容量报告与瓶颈清单。
    - 安全测试：OWASP ZAP 被动扫描 + 关键路由手动渗透用例。
- 阶段5（1周）：专家评审与收尾
    - 专家评审：技术架构、性能与安全三方评审；问题闭环与结项报告。
    - 运维交付：操作手册、回滚预案、值班与告警策略完善。

## 安全与自主可控

- 技术选型：坚持现有可控栈（Next.js/React/TS/Tailwind、Vitest、Playwright、Zod、Redis 可选）；必要功能优先自研或封装适配层（AI Provider 抽象）。
- 数据与隐私：最小权限原则与敏感数据脱敏；禁止在日志中输出密钥与个人信息；密钥统一管控。
- 运行隔离：生产启用严格 CSP、禁用 `unsafe-eval`；中间件拦截写操作非可信来源；速率限制与幂等贯穿关键路径。

## 测试与验收标准

- 覆盖率：单元测试行/语句≥95%、函数≥85%、分支≥84%（保持或提升现有阈值）。
- 性能指标：
    - 前端：Lighthouse Performance ≥ 90；LCP ≤ 2.5s（P75）；交互延迟 ≤ 100ms（P95）。
    - 服务端：核心 API P95 延迟 ≤ 200ms；错误率 ≤ 0.1%；稳态 QPS 提升≥30%。
- 安全指标：通过 CSP/CSRF/CORS 校验；OWASP Top 10 零高危；依赖 SCA 零高危。
- 业务连续性：灰度发布不影响存量用户；零停机上线；回滚平均耗时 ≤ 10 分钟。

## 文档与评审

- 技术评估报告：架构现状、问题清单与风险矩阵；建议与优先级排序。
- ADR（架构决策记录）：关键决策与备选方案对比；影响评估与回滚策略。
- API 契约与 OpenAPI 文档：路由、入参/出参与错误模型；版本化说明。
- 评审流程：阶段评审（进入下一阶段的门槛）+ 终期专家评审；结项报告与改进建议。

## 里程碑与交付物

- M0：评估与基线（报告+度量看板+风险清单）。
- M1：架构固化与边界（耦合修复与契约稳定）。
- M2：安全与自主可控（CSP/RBAC/供应链安全与限流幂等强化）。
- M3：性能优化（缓存/拆分/资源效率）与指标告警完成。
- M4：测试体系（单元/集成/压力/安全）与验收通过。
- M5：专家评审与运维交付（操作手册/回滚预案/值班策略）。

以上方案在不影响现有业务的前提下，稳步提升质量、性能与可维护性，并符合国家发展战略与自主可控要求。请确认后，我将据此开始分阶段实施。
