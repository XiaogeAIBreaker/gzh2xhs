## 项目现状速览
- 技术栈：Next.js 14（App Router）+ React 18 + TypeScript 5
- 目录清晰：`src/app` 页面与 API，`src/interfaces/http` 控制器/中间件，`src/domain` 领域模型，`src/application` 用例
- 基建完善：ESLint/Prettier/Husky、Vitest 覆盖率高、GitHub Actions CI、Tailwind 样式
- 性能与稳态：内存 LRU 缓存（`src/shared/lib/cache.ts`）、限流（可选 Redis 回退内存），统一 HTTP 封装与 zod 校验

## 总体原则
- 模块边界清晰、依赖自上而下（App → Interfaces → Application → Domain → Shared）
- 以“幂等、可回滚、可观测”为重构底线
- 优先复用现有栈与工具，新增依赖需“收益>复杂度”

## 项目结构优化
- 目录分层对齐 DDD：
  - `src/domain`（纯模型/规则）、`src/application`（用例）、`src/interfaces/http`（适配器与策略）、`src/shared`（横切关注）
- 页面/功能模块化：`src/app/(feature)/...` 与路由分组，公共 UI 组件沉淀至 `src/components`
- 强化边界检查：完善 `dependency-cruiser` 规则，禁止下层依赖上层与循环依赖
- 配置统一出口：`src/config/index.ts` 提供环境、特性开关（如 Redis/缓存 TTL/并发阈值）

## 代码质量提升
- ESLint 规则增强：复杂度/函数长度/禁止隐式 any/禁用未使用导入与变量（保持现有风格）
- Typescript 收紧：在核心路径启用更严格 `noUncheckedIndexedAccess` 等（按模块推进）
- DRY 落地：抽取重复的 `fetch`/错误处理到 `src/lib/http.ts`；统一错误类型与状态码
- 防御性编程：控制器入参 `zod` 校验必经；所有外部调用增加超时/重试/熔断与降级（复用 `src/services/types.ts`）

## 性能优化
- 服务端：
  - 幂等与 ETag：API 返回 `ETag`，命中 `If-None-Match` 直接 304
  - `Cache-Control` 与 CDN 友好头；对只读接口设置合理 `s-maxage` 与 `stale-while-revalidate`
  - Next App Router 缓存：对可缓存数据使用 `revalidate`/标签化缓存
- 客户端：
  - 并行请求 `Promise.all`/`allSettled`；避免串行瀑布
  - 关键交互按需 lazy/动态导入；列表使用虚拟化（如现有内容规模触发）

## 并发与稳态
- 服务端并发控制：对外部 AI 服务调用增加 `p-limit` 栅栏与队列（可用轻量实现替代依赖）
- 背压与降级：限流命中返回友好错误；缓存命中直接回包；Redis 不可用自动回退内存
- 观测：统一 `logger` 埋点；关键路径添加时间统计与请求 ID 透传

## 缓存策略
- 端到端：
  - 请求级幂等缓存（已有）进一步标准化 key（用户ID+payload hash+版本）
  - 结果缓存：只读查询 TTL 细分；强一致路径不缓存
- 层级化：内存 LRU（热点）→ Redis（跨实例）→ CDN（静态/半静态）
- 失效策略：写操作后精确失效相关 key 或标签化失效

## 测试保障
- 单元：针对 `src/interfaces/http/controllers/*.ts`、`src/shared/lib/*.ts` 增补边界/异常覆盖
- 集成：API 端到端用例（成功/失败/限流/缓存命中/幂等重复）
- UI：关键交互组件快照与行为测试（轻量）
- 性能基线：在 CI 中跑关键接口基准（P95/P99 时延、命中率）并做阈值守门

## CI/CD 强化
- CI 阶段：lint → typecheck → build → dep:check → test:coverage → perf-baseline
- 缓存 npm 与构建产物；引入变更集影响分析（仅跑受影响测试）
- 质量门禁：覆盖率阈值守门、依赖循环禁止、ESLint 严格失败

## 文档完善
- 架构路线图：在 `docs/` 绘制模块关系与数据流（Mermaid 图）
- API 文档：完善 OpenAPI schema 与示例；自动生成客户端 SDK 类型
- 运维手册：配置项说明、开关可视表、性能参数与调优指南
- 变更记录：ADR（架构决策记录）与 Changelog

## 风险与回滚
- 每步改动最小可回滚：保留旧代码路径临时开关
- 灰度发布：按路由或接口逐步启用
- 失败信号：时延、错误率、限流命中率异常自动回滚

## 交付标准（验收）
- 代码质量：lint 全绿、循环依赖 0、类型检查无误
- 性能：核心 API P95 时延降低 ≥30%，缓存命中率 ≥60%
- 稳定性：错误率 ≤0.1%，在 Redis 不可用下功能退化但不崩溃
- 测试：覆盖率满足现有阈值或更高，端到端用例通过
- 文档：架构图/API/运维/ADR 完整更新

## 实施里程碑
- M1 结构与规则：边界检查、配置统一、ESLint 强化
- M2 性能与并发：缓存/并发控制/客户端优化
- M3 测试与CI：补全用例、性能基线、质量门禁
- M4 文档与交付：架构图、OpenAPI 完善、运维手册

请确认是否按此计划执行，我将按里程碑推进并逐步提交改动与验证。