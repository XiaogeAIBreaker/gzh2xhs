# 重构设计文档

## 目标

- SOLID/DRY、圈复杂度≤10、单测覆盖≥90%、静态分析（Sonar）通过
- 性能：延迟降低≥20%、内存降低≥15%、并发吞吐提升≥30%
- 业务增长：KPI 监控、A/B 测试、数据采集

## 架构与模块

- 分层：interfaces → application(usecases) → infrastructure/providers|repositories → shared/lib
- 依赖注入：`src/container/index.ts`
- 关键模块：
  - 控制器：`src/interfaces/http/controllers/GenerateController.ts`
  - 用例：`src/application/usecases/GenerateCardUseCase.ts`
  - AI 抽象：`src/services/types.ts`（重试/超时）
  - 图片管线：`src/shared/lib/image-converter.ts`（emoji 检测、并发限速）
  - 指标：`src/shared/lib/metrics.ts`
  - A/B：`src/shared/lib/ab.ts` + `src/middleware.ts`

## 设计模式

- Strategy：AI 服务选择与处理策略
- Factory：`createAIService` 统一创建与配置
- Decorator：在调用层引入重试/超时装饰
- Adapter：指标输出适配现有 `logger`

## 关键改动

- KPI 埋点：API 成功/失败、耗时、缓存命中、限流等
- A/B 分配：在中间件稳定分桶，控制器/用例读取并记录
- 图片管线优化：无 emoji 时走 sharp；移除固定等待，改为 DOM 就绪
- AI 调用：Abort + 指数回退重试
- 规范门槛：ESLint complexity≤10；Vitest 覆盖阈值提升并配置范围
- 静态分析：SonarQube 项目与 CI 扫描

## 接口与边界

- 用例入参新增 `variant?: 'A'|'B'`（默认 A）
- 中间件写入 `X-Experiment-Variant` 与 `ab_variant` Cookie
- 指标 API：`counter/gauge/observe/summary`

## 风险与回滚

- 风险：外部 API 依赖、Playwright 环境、并发调度
- 控制：特性开关、灰度与回滚、错误预算监控
