## 项目现状与边界

- 架构：Next.js 14（App Router）+ React + TypeScript + Tailwind；API 路由位于 `src/app/api/*/route.ts`，控制器在 `src/interfaces/http/controllers/*`，领域逻辑在 `src/domain/finance/*`。
- 测试：Vitest 已配置，当前测试覆盖有限（示例在 `tests/http.test.ts`）。
- 工具：ESLint/Prettier、Dependency Cruiser（`dependency-cruiser.config.cjs` 生成依赖图 `docs/deps.json`）、CI 工作流（`.github/workflows/ci.yml`）。

## 基本面分析阶段

- 架构价值评估：
    - 以“分层清晰度、耦合度、稳定性、可替换性、复用度、复杂度、变更频率”7项指标为主线评估各层（接口/应用/领域/基础设施/表现/共享）。
    - 结合依赖图中心性与入度/出度，识别“护城河核心模块”（如 `src/domain/finance/pricing/*`、`src/lib/http.ts`、`src/shared/lib/cache.ts`）。
- 静态代码分析量化：
    - ESLint 严格规则组（类型与安全相关规则、`unused-imports`、复杂度阈值）。
    - 依赖健康度：循环依赖/跨层依赖检查（Dependency Cruiser）。
    - 不可达/未用代码：`knip`/`ts-prune` 建议纳入分析基线。
- 代码质量评分体系：
    - 每模块A/B/C/D 四等级：A（优质资产）满足“高覆盖、低复杂、耦合受控、接口稳定”；D（不良资产）触发“循环依赖、低覆盖、跨层泄漏、异常无防御”。
    - 输出《模块价值评估表》：模块、分层、分数、论据、关键风险。

## 重构投资原则

- 安全边际（测试冗余）：
    - 核心域/控制器目标覆盖≥80%，整体覆盖≥60%，并在质量门设置“最低门槛+30%冗余”（例如最低50%，门控80%）。
- 技术护城河（多层防御）：
    - 接口层：输入校验（Schema/Zod 或现有 `src/types/schemas.ts`）、限流与幂等（`src/shared/lib/rateLimiter.ts`、请求`idempotency-key`）。
    - 应用层：用例级断言/不变式，边界错误封装统一为 `jsonError`（`src/lib/http.ts`）。
    - 领域层：纯函数、确定性、边界检查与属性测试；错误集中于 `src/domain/finance/errors.ts`。
    - 基础设施层：超时/重试/熔断、资源上限与缓存策略。
- 变更审批机制：
    - PR 模板（成本/收益/风险/回滚计划/测试影响）。
    - CODEOWNERS 指定领域评审人（金融算法、HTTP 中间件、缓存/限流）。
    - CI 质量闸：lint、依赖健康、测试与覆盖阈值、构建、OpenAPI 一致性校验。

## 价值重构实施

- 模块价值矩阵：
    - 维度：价值（业务关键度、复利潜力、可替代性低）× 风险（复杂度、缺陷率、依赖度）。
    - 优先队列：高价值/高风险先（如 `pricing`/`risk` 计算域、`http` 响应工具、API 控制器）。
- 精简投资组合：
    - 移除重复与过度设计：统一 `src/lib/*` 与 `src/shared/lib/*` 的重复封装；合并冗余转换器/缓存包装器；消除跨层耦合与循环。
    - 提升内聚：将散落的校验/异常处理提升为共享策略，收敛到中间件或用例基类。
- 标准化文档体系（“财务报告”式）：
    - 每模块`README.md`：使命/边界、公开接口、依赖关系、复杂度与覆盖、稳定性评级、技术债务与处置计划、KPI（变更频率、缺陷率、ROI 预估）。
    - 架构决策记录（ADR）：关键设计与取舍。

## 质量管控标准

- 成本收益分析（每次重构必须）：
    - 成本：开发与测试工时、迁移风险、兼容成本；收益：性能、可维护性、故障率下降、交付速度提升。
- 10年可维护性检查清单：
    - 无循环依赖；清晰模块边界；接口稳定与版本化；文档齐备；测试足量且独立；低认知负荷；最小必要耦合；替换成本可控；安全与资源上限内置。
- 能力圈原则：
    - 金融模型更改需领域专家共评审；中间件与安全策略由平台专家共评审；CI 强制至少两人签核。

## 价值交付要求

- 重构报告输出：
    - 模块价值评估表、技术债务清算清单、ROI 分析（含数据与假设）。
- 性能对比数据：
    - 执行效率：API 路由基准（吞吐/QPS、p95 延迟）；
    - 内存占用：关键用例与 worker（`src/infrastructure/workers/financePool.ts`）运行峰值与均值；
    - 启动时间：`next dev`/`next start`冷启动与热重载时延。
- 回归测试：
    - 100%核心业务场景：金融价格/风险/报表三大用例、卡片生成/导出、HTTP 错误与鉴权、限流与幂等、OpenAPI 路由一致性。

## 初始度量与里程碑

- T0 建立基线：
    - 覆盖率快照、依赖图健康度、性能基准、缺陷率与变更频率。
- 里程碑（示例）：
    - M1：完成评分体系与矩阵、CI 质量门与PR模板；
    - M2：核心域护城河（校验/不变式/属性测）、控制器防御与幂等；
    - M3：清算技术债与合并重复封装、文档与ADR齐备；
    - M4：性能/内存/启动对比与ROI 报告出具。

## 风险控制与回滚

- 蓝绿或灰度发布；关键路由版本化；保留回滚脚本与数据迁移的逆操作；对高风险模块设保护性开关与特性标志。

## 下一步行动（待确认后执行）

- 生成《模块价值评估表》与`docs/deps.json`可视化并发布。
- 增设 CI 质量门（lint/依赖健康/测试覆盖/构建/契约校验）。
- 为金融域与控制器建立防御性编程与属性测试基线；明确核心场景清单并开始补齐回归。
