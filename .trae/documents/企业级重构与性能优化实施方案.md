## 总体目标

- 满足 SOLID/DRY，圈复杂度≤10，全量通过静态分析（含 SonarQube）
- 单元测试覆盖率≥90%（lines/functions/statements），branches≥85%
- 性能：执行时间提升≥20%，内存占用降低≥15%，并发能力提升≥30%
- 商业：内置 KPI 监控、关键指标埋点、A/B 测试集成、完善的数据采集能力

## 基线评估（不改代码）

- 运行现有基准脚本并记录 p50/p90/p95/p99、avg 等指标（docs/perf-baseline.md 指南；scripts/perf/basic-bench.mjs）
- 收集当前测试覆盖率与 ESLint/依赖循环检查（vitest+dependency-cruiser）
- 形成“现状报告”作为后续对比基线

## 架构与代码重构

- 控制器/用例分层保持，细化职责与接口：
  - 拆分 `GenerateCardUseCase.execute` 以降低复杂度并引入策略/管道模式（src/application/usecases/GenerateCardUseCase.ts:29）
  - 统一 HTTP 错误映射与返回（src/domain/errors.ts:8；src/lib/http.ts:13）
- 设计模式强化：
  - Strategy：AI 服务选择已存在（src/services/index.ts:31），补充可插拔的前/后处理管道
  - Factory：维持 `createAIService`，新增缓存/重试装饰器
  - Adapter：为 logger 增加 metrics 适配层（将业务事件转换为度量）
- 模块边界与依赖约束：
  - 使用 dependency-cruiser 规则增强（dependency-cruiser.config.cjs:8）并消除循环/孤儿模块
  - 在 `src/container` 明确 DI 容器角色与接口（src/container/index.ts:9）
- DRY 提取：
  - 缓存 key 生成、速率限制检查、SVG 校验等通用逻辑抽取为可复用工具

## 性能优化

- 渲染路径优化：
  - 移除 Playwright 固定 `waitForTimeout`，改为 DOM/字体加载就绪检测，减少无效等待（src/shared/lib/image-converter.ts:71）
  - 提升并发：将 `maxConcurrent` 参数化，结合轻量队列/信号量提升吞吐（src/shared/lib/image-converter.ts:39）
- I/O 与内存：
  - PNG 生成管线优化，避免冗余 Buffer 拷贝，必要处使用流/增量处理（sharp 管线，src/shared/lib/image-converter.ts:165）
  - 结果缓存与命中率优化（CacheRepository；src/infrastructure/repositories/CacheRepository.ts:3）
- 远程调用：
  - 为 `callAPI` 增加轻量重试与超时控制；复用连接以降低延迟（src/services/types.ts:94）
- 目标与验证：
  - 基准脚本对比前后 p95/avg 性能提高≥20%，并发场景下吞吐提升≥30%
  - 通过 `process.memoryUsage()` 与图片处理字节数统计证明内存下降≥15%

## 业务指标与增长能力

- KPI 埋点：
  - generate 成功率、延迟分布、缓存命中率、限流拦截数、AI 失败率
  - 在控制器与用例关键节点埋点（src/interfaces/http/controllers/GenerateController.ts:10；src/application/usecases/GenerateCardUseCase.ts:29）
- 指标采集：
  - 新增 `src/shared/lib/metrics.ts`：提供 `counter/histogram/gauge` API，输出 JSON Lines（与现有 `logger` 对接，src/lib/logger.ts:34）
- A/B 测试：
  - 新增 `src/shared/lib/ab.ts`：一致性哈希分配变体；通过 `middleware` 写入 cookie/header（src/middleware.ts:28）
  - 用例根据变体选择风格/模型，并上报转化率指标

## 测试与质量门槛

- 覆盖率提升：
  - 为负路径补齐单测（校验失败、限流、SVG 过短、图片验证失败）
  - 控制器、用例、服务、工具层均覆盖；增加分支覆盖
- 阈值/报告：
  - 将 vitest 覆盖阈值提升至 90%/85%（src/vitest.config.ts:8）并增加 `lcov` 报告供 Sonar 解析
  - CI 中上传覆盖与测试产物（.github/workflows/ci.yml:45）

## 静态分析与规范

- SonarQube 集成：
  - 新增 `sonar-project.properties`（源码路径、测试路径、覆盖报告、排除项）
  - CI 加入 sonar-scanner 步骤与 Quality Gate（失败则阻止合并）
- ESLint 强化：
  - 开启 `complexity`≤10、`no-unsafe-finally` 等规则（.eslintrc.json）
  - import 规范与未用代码剔除已启用（.eslintrc.json:3）

## 交付物清单

- 重构设计文档：目标、方案、模块边界、模式选型、接口定义
- 变更影响分析报告：对性能、风险、兼容性、运维的影响与回滚策略
- 性能基准测试结果：前后对比（p50/p95/avg/ok/fail/吞吐/内存）
- 代码审查 Checklist：SOLID/DRY、复杂度、测试覆盖、静态分析、边界与错误处理、指标埋点

## 变更影响与风险控制

- 影响面：AI 调用、图片管线、缓存/限流、中间件、控制器/用例接口
- 风险：外部 API 波动、Playwright/Sharp 环境依赖、并发调度
- 控制：特性开关、灰度发布、回滚脚本、错误预算监控

## 验收标准

- CI 全绿：lint/typecheck/build/test/coverage/sonar quality gate 均通过
- 覆盖率≥90%，复杂度门槛达标，依赖循环检查通过
- 基准对比达到三项性能指标
- 指标与 A/B 埋点在日志/报告中可见并可聚合

如需我开始实施，请确认该方案。
