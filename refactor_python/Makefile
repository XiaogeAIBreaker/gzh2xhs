# Makefile for Python Refactoring Project
# æä¾›ç»Ÿä¸€çš„å¼€å‘ã€æµ‹è¯•ã€æ„å»ºå‘½ä»¤

.PHONY: help install install-dev test test-cov lint format type-check security clean build docs serve

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸš€ Pythoné‡æ„é¡¹ç›® - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "ğŸ“¦ å®‰è£…ç›¸å…³:"
	@echo "  install      - å®‰è£…ç”Ÿäº§ä¾èµ–"
	@echo "  install-dev  - å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  install-all  - å®‰è£…æ‰€æœ‰ä¾èµ–"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•ç›¸å…³:"
	@echo "  test         - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-cov     - è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  test-integration - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  test-performance - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  test-all     - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo ""
	@echo "ğŸ” ä»£ç è´¨é‡:"
	@echo "  lint         - è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  format       - æ ¼å¼åŒ–ä»£ç "
	@echo "  type-check   - è¿è¡Œç±»å‹æ£€æŸ¥"
	@echo "  security     - è¿è¡Œå®‰å…¨æ‰«æ"
	@echo "  quality      - è¿è¡Œæ‰€æœ‰è´¨é‡æ£€æŸ¥"
	@echo ""
	@echo "ğŸ“Š æ€§èƒ½åˆ†æ:"
	@echo "  profile      - è¿è¡Œæ€§èƒ½åˆ†æ"
	@echo "  benchmark    - è¿è¡ŒåŸºå‡†æµ‹è¯•"
	@echo "  memory       - å†…å­˜ä½¿ç”¨åˆ†æ"
	@echo ""
	@echo "ğŸ”§ å¼€å‘å·¥å…·:"
	@echo "  clean        - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  build        - æ„å»ºé¡¹ç›®"
	@echo "  docs         - ç”Ÿæˆæ–‡æ¡£"
	@echo "  serve-docs   - å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨"
	@echo "  run-dev      - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo ""
	@echo "ğŸš€ éƒ¨ç½²ç›¸å…³:"
	@echo "  docker-build - æ„å»ºDockeré•œåƒ"
	@echo "  docker-run   - è¿è¡ŒDockerå®¹å™¨"
	@echo "  deploy       - éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"

# å®‰è£…ç›¸å…³
install:
	pip install -r requirements.txt

install-dev:
	pip install -r requirements.txt
	pip install -e ".[dev]"

install-all:
	pip install -r requirements.txt
	pip install -e ".[dev,docs,perf]"

# æµ‹è¯•ç›¸å…³
test:
	pytest tests/ -v

test-cov:
	pytest tests/ --cov=gzh2xhs_refactor --cov-report=term-missing --cov-report=html --cov-report=xml

test-integration:
	pytest tests/integration/ -v

test-performance:
	pytest tests/performance/ -v --benchmark-only

test-all:
	pytest tests/ --cov=gzh2xhs_refactor --cov-report=term-missing

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
	ruff check src/ tests/
	flake8 src/ tests/
	pylint src/gzh2xhs_refactor/

format:
	ruff format src/ tests/
	black src/ tests/
	isort src/ tests/

type-check:
	mypy src/

security:
	bandit -r src/
	safety check

quality: format lint type-check security
	@echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡"

# æ€§èƒ½åˆ†æ
profile:
	python -m cProfile -o profile_output.prof -m pytest tests/ --benchmark-only
	python -c "import pstats; pstats.Stats('profile_output.prof').sort_stats('cumulative').print_stats(20)"

benchmark:
	python scripts/benchmark.py

memory:
	python -m memory_profiler scripts/benchmark.py

# å¼€å‘å·¥å…·
clean:
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .coverage htmlcov/ .pytest_cache/ .mypy_cache/
	rm -rf dist/ build/ *.egg-info/
	find . -type f -name ".DS_Store" -delete

build: clean
	python -m build

docs:
	cd docs && make html

serve-docs:
	cd docs/_build/html && python -m http.server 8000

run-dev:
	uvicorn src.gzh2xhs_refactor.main:app --reload --host 0.0.0.0 --port 8000

# Dockerç›¸å…³
docker-build:
	docker build -t gzh2xhs-refactor:latest .

docker-run:
	docker run -p 8000:8000 gzh2xhs-refactor:latest

# éƒ¨ç½²
deploy:
	@echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
	@echo "è¯·é…ç½®å…·ä½“çš„éƒ¨ç½²è„šæœ¬"

# CI/CDæµæ°´çº¿
ci: clean install-dev test-cov lint type-check security
	@echo "âœ… CIæ£€æŸ¥å…¨éƒ¨é€šè¿‡"

# é¢„æäº¤æ£€æŸ¥
pre-commit: format lint type-check
	@echo "âœ… é¢„æäº¤æ£€æŸ¥é€šè¿‡"