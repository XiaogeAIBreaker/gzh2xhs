# 安全审计与风险清单（M0）

## 清单与现状

- 安全头：`next.config.js` 已配置 CSP、X-Frame-Options、X-Content-Type-Options、Referrer-Policy、HSTS、Permissions-Policy；生产禁用 `unsafe-eval`，`connect-src` 限定到自身与 AI 域。
- CORS/CSRF：`src/middleware.ts` 检查 Origin，拦截写操作；预检响应包含允许方法与头；跨域允许按白名单。
- 认证与授权：`src/interfaces/http/middleware/auth.ts` 解析 Bearer；`rbac.ts` 以动作清单控制角色访问；错误响应统一。
- 速率限制与幂等：关键路由使用限流与 `x-idempotency-key`；本地 LRU/TTL 缓存实现缓存与幂等。
- 依赖与供应链：`package-lock.json` 锁定；`dependency-cruiser` 检查；CI 执行质量与测试。

## 风险项（优先级高→低）

1. 集群一致性：幂等/限流在无 Redis 时仅本地缓存，存在跨实例不一致风险。
2. CSP 例外：开发模式放宽；需确保生产严格来源与最小权限。
3. Cookie 属性：AB 分流 `ab_variant` 为非 HttpOnly；虽为非敏感数据，但需评估篡改影响与必要性。
4. 构建依赖：生产构建缺少 `swagger-ui-react`，存在上线阻断风险与供应链不完整风险。
5. 日志隐私：需核查日志中是否有潜在敏感信息输出，完善脱敏策略与日志分级。

## 建议与整改措施

- 一致性：提供 Redis 后端用于限流与幂等（保留本地降级）；配置最小 TTL 与窗口策略，增加防重放保护。
- CSP 强化：生产环境精简 `connect-src` 至必要域；`img-src` 与 `style-src` 进一步约束第三方；评审外部域清单。
- Cookie 策略：若需前端可读 AB 标签，保留 `httpOnly: false`；同时增加服务端校验，防止客户端篡改影响实验统计。
- 供应链：补齐 `swagger-ui-react` 依赖或改为按需/动态引入；引入依赖 SCA 扫描与内部镜像策略。
- 密钥与隐私：统一密钥管理；禁止输出个人信息与密钥到日志；制定日志留存与访问策略。

## 结论

整体安全控制基础良好；通过一致性、CSP 强化与供应链治理，可满足更高安全等级与自主可控要求。
