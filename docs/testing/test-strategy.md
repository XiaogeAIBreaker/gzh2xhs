# 测试策略与覆盖率门槛

## 测试金字塔
- 单元测试（基座）：
  - 目标：纯逻辑与领域规则，隔离外部依赖；快速稳定。
  - 工具：`vitest`（前端/Node）、`pytest`（Python）。
  - 门槛：行/语句/函数 ≥ 90%，分支 ≥ 85%，关键领域类与函数必须覆盖核心路径。
- 集成测试（中层）：
  - 目标：模块间协作、数据库/缓存/消息与事务性校验。
  - 工具：Testcontainers/Docker Compose；固定测试数据与回滚。
  - 要点：连接池/重试/超时/熔断策略校验；一致性与并发冲突用例。
- 契约测试（对外与跨服务）：
  - 目标：OpenAPI/JSON Schema 契约一致；变更可控。
  - 工具：契约生成/校验与 Diff 门禁；客户端/服务端类型生成。
- 端到端（顶层）：
  - 目标：关键用户路径与框架集成；可观测性与错误处理。
  - 工具：Playwright；冒烟与回归套件；报告归档。

## 度量与门禁
- 覆盖率：
  - 在 `vitest` 与 `pytest-cov` 强制阈值；CI 未达标阻断合并。
  - 重要模块设置更高阈值或必须用例清单（如 Finance/生成/导出）。
- 质量规则：
  - 圈复杂度与重复率阈值；依赖巡航与无环校验；安全规则（禁用危险 API）。
- 报告与趋势：
  - 生成覆盖率 XML/HTML；在 CI 归档并上传；趋势图与基线比较。

## 测试夹具与隔离
- 统一夹具与数据构造器；避免跨测试隐式依赖；使用随机但可重复的种子。
- 对外调用以 Mock/Stub/沙箱服务隔离；端到端测试使用专用环境与数据集。

## 性能与可靠性测试
- 基准：针对热点路径，含序列/并发场景与不同负载曲线。
- 压测：目标 p95 延迟、吞吐、错误率与资源利用；触发与回滚策略演练。

## 失败分析与回归流程
- 失败优先：记录上下文与关联 ID；输出错误摘要与直达修复线索。
- 回归：修复必须附带用例；防止问题复燃的守护用例长期保留。
