# 技术评估报告（M0 基线）

## 项目概览

- 技术栈：Next.js 14（App Router）+ React 18 + TypeScript + Tailwind CSS。
- 服务层：Next API Routes，含生成/导出/埋点/KPI/金融子域等。
- 质量与工具：Vitest（V8 覆盖率）、ESLint、Prettier、Husky、Dependency-Cruiser、Playwright（库方式）、Sharp、Zod、可选 Redis。

## 架构与分层

- 前端：`src/app`（页面/布局/错误页）与 `src/components`（UI 组件），`src/context`（全局状态）。
- 应用层：`src/application/usecases/*`；领域层：`src/domain/*`；接口层：`src/interfaces/http/*`；基础设施与共享库：`src/infrastructure/*`、`src/shared/lib/*`；配置与文档：`src/config`、`src/docs`。

## 依赖健康（Dependency-Cruiser）

- 命令：`npm run dep:json` 已生成 `docs/deps.json`。规则：禁止循环依赖、提示孤儿模块。
- 初步结论：分层清晰，无显著循环依赖；个别模块存在孤儿提示，建议按功能聚合或清理。

## 安全与合规

- 安全头：`next.config.js:6-38` 配置 CSP/安全头，生产移除 `unsafe-eval`，`connect-src` 限定到 AI 域与自身。
- 中间件与鉴权：Origin 写操作拦截、RBAC 动作清单与 Bearer 解析；限流与幂等键在关键路由生效。
- 供应链：`package-lock.json` 锁定；CI 含依赖健康检查；需要补充 SCA 报告与内部镜像策略文档。

## 质量与测试

- `vitest.config.ts`：覆盖率阈值高（行/语句≥95、分支≥84、函数≥85）；排除了 UI 与 App Router 以保证业务逻辑测试集中。
- 建议：补充 API 契约测试与限流/鉴权集成场景；压力测试工具引入（k6/Artillery）。

## 问题与风险清单（摘录）

1. 组件承担部分业务逻辑，易造成重渲染与耦合（`src/components/*`）。
2. 无 Redis 时幂等/限流依赖本地缓存，集群一致性风险（`src/shared/lib/cache.ts`）。
3. 开发环境 CSP 放宽；需确保生产更严格与例外白名单受控（`next.config.js`）。
4. 性能与容量基线未固化到持续看板；缺少热点路径压测与容量报告。
5. API 版本化策略未系统化记录，灰度回滚与契约稳定性文档不足。

## 建议与改进方向（M1-M3 对应）

- 架构固化：
    - 组件容器化与业务逻辑下沉至 `application/usecases`；统一 hooks 调用路径。
    - 依赖治理：修复跨层耦合，确保领域层不依赖 UI。
- 安全与自主可控：
    - 强化 CSP 与 Permissions-Policy；RBAC 动作与鉴权路径复核；供应链安全报告落地。
    - 限流与幂等迁移至 Redis（保留本地降级）。
- 性能优化：
    - 路由级代码拆分、Tailwind tree-shaking、图片优化；缓存策略与 TTL 梳理。
    - 指标与告警：建立 SLO/SLA 与报警规则。

## 结论

项目基础扎实、分层清晰、安全控制到位；通过分阶段重构与度量体系落地，可在不影响业务的前提下提升质量、性能与可维护性。
