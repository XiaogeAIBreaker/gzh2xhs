# 系统性重构方案（架构/技术/安全/性能）

## 目标与范围

- 提升可维护性与可扩展性：清晰分层、解耦服务与路由、抽象可替换的 AI Provider。
- 强化安全与合规：认证授权、响应安全头、CORS/CSRF/输入校验、密钥与日志脱敏、稳健限流。
- 改善性能与稳定性：浏览器池化、并发与流式处理、结果缓存、AI 请求优化、运行时声明与构建优化。
- 完善工程能力：测试与覆盖率、CI/CD、Lint/格式化、可观测性（日志/指标/链路）。

## 当前状态概览（依据代码库）

- 技术栈：Next.js 14（App Router）/ React 18 / TypeScript / Tailwind / Vitest / Playwright / Sharp / Zod / JSZip。
- 架构：前后端一体的单仓库；API 路由位于 `src/app/api/*`；业务模块在 `src/services/*`、`src/hooks/*`、`src/context/*`、`src/components/*`、`src/lib/*`。
- 安全：无认证与授权；未设置安全响应头、CORS、CSRF；有 Zod 输入校验与基础内存限流。
- 性能：Playwright 每次请求新建浏览器；顺序处理、无结果缓存；AI 请求高 tokens、缺重试与超时；Zip 与图片转换一次性内存峰值风险。
- 工程：Vitest 单元测试少，未启用覆盖率；无 CI；ESLint 基于 Next 默认、未配置 Prettier；路径别名在 tsconfig 中，测试未适配。

## 架构改造

- 分层与目录
    - 引入服务端分层：`src/server/{controllers,services,repositories}`；Controller 仅处理协议/校验/响应，Service 聚合业务，Repository 封装外部/持久化。
    - 保留现有 `src/services/*` 作为 Provider 层，抽象统一接口 `IAIProvider`，通过工厂/DI 注入。
    - 将通用工具归档至 `src/lib` 并拆分：`lib/http`、`lib/logger`、`lib/cache`、`lib/rateLimiter`、`lib/image`。
- DTO/Schema 与错误
    - 继续使用 Zod 统一请求/响应 Schema；定义 DTO 层与错误类型；`lib/http` 统一 `jsonOk/jsonError` 与错误码/可观察字段。
- 运行时
    - Playwright 相关 API 路由显式声明 `runtime = 'nodejs'`；轻量只读接口可考虑 `runtime = 'edge'`。

## 技术栈与工程实践

- TypeScript 强化：启用 `strict`、`noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`；完善类型边界（AI 响应/设计 JSON）。
- 代码规范：引入 Prettier 与 `.eslintrc`（含别名解析、严格规则）；`husky + lint-staged` 统一提交质量。
- 构建优化：`@next/bundle-analyzer`；`modularizeImports`（如 lodash）；明确 Node 版本与包管理锁（npm/pnpm 统一）。

## 安全增强

- 认证与授权
    - 方案 A：`next-auth`（Credentials/OAuth），服务端 Session；在 API 路由校验 Session/角色。
    - 方案 B：自定义 JWT（短期可行），在中间件或 Controller 校验并授权。
- 安全响应头
    - 通过 `next.config.js` 的 `headers()` 或中间件设置：`Content-Security-Policy`、`X-Frame-Options`、`Strict-Transport-Security`、`X-Content-Type-Options`、`Referrer-Policy`、`Permissions-Policy`。
- CORS 与 CSRF
    - CORS：基于环境变量白名单域、方法与头；默认拒绝通配。
    - CSRF：对状态变更接口（POST）加入 token（双重提交或 SameSite Cookie 策略）。
- 输入与输出安全
    - 保留 Zod；为 SVG 增加服务端清洗（SVGO 安全配置或 DOMPurify with JSDOM）。
- 机密管理与日志
    - 环境变量仍由 `src/config` 管理并 Zod 校验；文档仅示例占位符；日志中统一脱敏（如 `apiKey`）。
- 速率限制
    - 将 `lib/rateLimiter` 替换为 Redis/Upstash 滑动窗口；限流维度包含 IP + 用户；加入 TTL 清理与代理链解析。

## 性能与稳定性

- 浏览器与页面池化
    - 在服务端维持 Playwright Browser/Context/Page 池；复用实例；使用 `p-limit` 控制并发，避免资源争夺。
- 渲染与图片管线
    - 用事件/状态替代固定等待（`networkidle`/字体加载）；Sharp 前置类型校验与最少管线；对异常快速回退。
- 结果缓存
    - 基于输入的内容哈希缓存：SVG/PNG/Zip 结果缓存（Redis LRU + 本地短暂 LRU）；设置 HTTP 缓存头（`ETag`/`Cache-Control`）。
- 并发与流式
    - API 内对批量任务使用并发限流；导出 ZIP 使用流式（如 `archiver`），降低内存峰值；必要时分块传输。
- AI 请求优化
    - 限制 `max_tokens` 与温度；增加重试（指数退避）与超时控制；对高命中场景缓存成功响应。
- Next.js 运行与构建
    - 明确需要 Node 运行时的路由；自托管或 Docker 化（Playwright 依赖完整）；启用 SWC 压缩与分析。

## 可观测性

- 结构化日志
    - 引入 `pino`（或现有 `lib/logger` 强化）统一日志级别、字段；注入 `requestId` 实现端到端关联；敏感字段脱敏。
- 指标与追踪
    - 集成 Prometheus 或 OpenTelemetry：路由级延迟/错误率/并发；服务调用（AI/渲染）耗时与失败计数；基础分布追踪（traceId）。

## 测试与 CI/CD

- 单元与集成测试
    - 为 `src/services/*`、`src/app/api/*` 增加单测与集成（mock Redis/Playwright）；`lib/image` 提供接口级测试与错误分支覆盖。
- 覆盖率与阈值
    - 在 `vitest.config.ts` 启用 coverage（v8，text+lcov），设定阈值（如 80% 行覆盖）。
- e2e 测试
    - Playwright `playwright.config.ts` 与基础脚本；在 Docker 中运行确保环境一致性。
- CI（GitHub Actions）
    - 流水线：`checkout → setup-node → install → lint → type-check → test → coverage → build`；必要时上传覆盖率（Codecov）。

## 运维与部署

- Docker 化
    - 多阶段构建，安装 Playwright 依赖；最小化镜像体积；健康检查；通过环境变量注入配置。
- 部署策略
    - Vercel Serverless 不适合 Playwright；将相关路由改为 Node 运行时、或迁移到自托管/边缘兼容替代方案。

## 交付物与文档

- ADR 与安全策略：记录架构决策、威胁模型、响应头策略与限流设计。
- 性能基线与指南：吞吐/时延目标、并发/缓存策略、常见故障应对（重试/断路器）。
- 开发者手册：目录/分层约定、编码与测试规范、CI 检查项、运行与调试说明。

## 实施顺序（无时间表，仅优先级）

1. P0 安全与运行基线：`headers/CORS/CSRF`、Redis 限流、密钥与日志脱敏、Node 运行时声明。
2. P1 认证与授权：接入 `next-auth` 或 JWT；API 权限收敛。
3. P2 性能：浏览器池化、并发与流式、结果缓存、AI 请求优化。
4. P3 工程与质量：覆盖率与测试扩展、CI、Lint/Prettier、Bundle 分析与优化。
5. P4 可观测性与运维：日志/指标/追踪、Docker 化、部署策略完善。

## 预计修改的关键文件（示例）

- 配置与安全：`next.config.js`、`src/config/index.ts`、`src/middleware.ts`（如新增）。
- 认证与授权：`src/app/api/*/route.ts`、`src/server/controllers/*`（如新增）、`src/pages/api/auth/*` 或 `src/app/api/auth/*`（next-auth）。
- 限流与缓存：`src/lib/rateLimiter.ts`、`src/lib/cache.ts`（新增）、`src/lib/http.ts`。
- 图像与渲染：`src/lib/image-converter.ts`（池化）、`src/app/api/export/route.ts`（并发/流式）。
- 服务抽象：`src/services/types.ts`、`src/services/index.ts`、`src/services/*`（AI Provider）。
- 工程与质量：`vitest.config.ts`、`playwright.config.ts`（新增）、`.github/workflows/ci.yml`（新增）、`.eslintrc.*`、`.prettierrc`、`Dockerfile`（新增）。

——请确认以上整体方案与优先级。如确认，我将按 P0→P1→P2 顺序逐项落地，并在每一步提供对应代码改动与验证（单测或本地预览）。
