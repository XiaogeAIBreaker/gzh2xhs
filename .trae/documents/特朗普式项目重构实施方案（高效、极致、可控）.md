# 特朗普式项目重构实施方案（高效、极致、可控）

## 核心目标
- 架构“巨大”：统一分层（interfaces/application/domain/infrastructure/shared），边界清晰、耦合最小。
- 代码“非常棒”：剔除冗余、简洁有力的函数、清晰命名、严密错误处理。
- 质量“完美”：测试覆盖对关键业务达 98–100%，整体阈值≥95%，零 ESLint 错误。
- 性能“更快”：端到端延迟与渲染优化，前端 Lighthouse≥90，核心 API P95≤200ms。
- 文档“详尽”：ADR、API 契约、运行手册与验收报告完整。

## 分阶段计划
- 阶段0：基线核实与阻断清除
  - 构建阻断修复：`src/app/api-docs/page.tsx` 缺失 `swagger-ui-react` 依赖导致生产构建失败（next 构建报错）。
  - 覆盖率与测试现状确认：`vitest.config.ts` 阈值与包含/排除清单。
  - 依赖图导出与问题清单：`docs/deps.json` 与循环/孤儿模块识别。
- 阶段1：架构重构与边界固化
  - 组件容器化：将 UI 组件中的业务流程下沉至 `src/application/usecases/*`，组件保持纯展示与交互。
  - 接口契约稳定：API Routes 入参 `zod` 校验与统一错误模型，版本化（保留 v1→引入 v2）。
  - 依赖治理：确保 `domain` 不依赖 UI；修复跨层依赖（参考 `dependency-cruiser.config.cjs`）。
- 阶段2：冗余清理与供应链安全
  - 清理死代码与重复实现；统一工具与适配层（如 AI Provider）。
  - 供应链安全：锁定 `package-lock.json`，SCA 扫描与内部镜像策略，第三方库来源评审。
- 阶段3：质量门禁与测试拉升
  - ESLint 零错误：修复空行/复杂度等规则（见 `next lint` 输出），保留必要的例外理由。
  - 覆盖率拉升：
    - 关键业务模块（usecases/controllers/shared/lib）目标 98–100%。
    - UI 层适度覆盖关键交互（事件与渲染分支）。
    - 新增契约与集成测试（鉴权/RBAC/限流/幂等）。
- 阶段4：性能优化与观测
  - 前端：路由级代码拆分、`next/image` 优化、Tailwind tree-shaking；减少不必要的客户端组件。
  - 服务端：缓存策略（LRU/Redis）与 TTL 梳理；热点路径并行与批处理。
  - 度量与告警：统一指标与日志分级，SLO/SLA 与报警规则。
- 阶段5：安全加固与灰度发布
  - CSP 强化：生产 `connect-src` 最小化（`next.config.js:6-38`）；Permissions-Policy 细化。
  - CSRF/CORS 中间件核查：`src/middleware.ts:30-53,63-82` 保持写操作拦截与预检正确。
  - 灰度/蓝绿与回滚：按路由/功能逐步放量，保留旧契约与一键回滚演练。
- 阶段6：文档与评审
  - ADR、API 契约（`src/docs/openapi.ts`）、操作手册与验收报告；专家评审与问题闭环。

## 关键实施要点
- 路由与页面：`src/app/*` 保持 App Router 模式，`layout.tsx`、`error.tsx` 与全局样式谨慎改动。
- 安全与鉴权：
  - 鉴权解析：`src/interfaces/http/middleware/auth.ts:5-12`；RBAC 动作：`rbac.ts:22-29`。
  - 幂等与限流：在关键路由保持 `x-idempotency-key` 与速率限制，优先引入 Redis 一致性后端（保留本地降级）。
- 组件关注点分离：例如 `Toast.tsx` 保持展示与状态隔离，交互通过 hooks/usecases 下沉。

## 验收与指标
- 构建：`npm run build` 无阻断；CI 全绿。
- 质量：ESLint 零错误；关键业务覆盖率≥98%，整体≥95%。
- 性能：Lighthouse≥90；核心 API P95≤200ms，错误率≤0.1%。
- 安全：OWASP Top 10 零高危；SCA 零高危；CSP/CSRF/CORS 检查通过。
- 文档：ADR、OpenAPI、运行与回滚手册完备。

## 风险控制
- 冻结与回滚窗口：阶段末设冻结期；蓝绿/灰度发布，支持快速回滚。
- 变更审查：重大改动附 ADR 与基准对比；日志隐私与密钥不落盘。