# 企业级架构重构实施计划

## 现状评估

- 技术栈：Next.js 14 App Router（`next`、`react`、`tailwindcss`）、TypeScript、Vitest、Playwright、ioredis
- 关键模块：
    - API 路由：`src/app/api/generate/route.ts:46`、`src/app/api/export/route.ts:19`
    - 服务层：抽象基类 `src/services/types.ts:68`，具体实现 `src/services/deepseek.ts:25`、`src/services/nanobanana.ts:27`
    - 通用能力：日志 `src/lib/logger.ts:34`，缓存 `src/shared/lib/cache.ts:5`，限流 `src/shared/lib/rateLimiter.ts:6`，Redis `src/shared/lib/redis.ts:5`
    - 中间件：基础 CORS/CSRF 校验 `src/middleware.ts:20`
    - 测试：单元测试在 `tests/`，CI 已跑覆盖率（`.github/workflows/ci.yml:30`）
- 问题与改进空间：
    - 层次结构未完全清晰（表现/业务/数据访问混杂在 `src/services` 与 `src/lib`/`shared`）
    - DI/IoC 缺失，请求作用域依赖管理不足
    - CI 未执行类型检查/构建/端到端测试；代码规范执行不全
    - 错误与日志具雏形但缺少统一错误模型、请求关联 ID、可观测性

## 目标架构（模块化三层 + IoC/DI）

- 表现层（Presentation）
    - 保持 Next App Router 路由；将路由处理仅做参数解析、调用用例、返回 HTTP
    - 新增 `src/interfaces/http/controllers/*`：如 `GenerateController`/`ExportController`，供 `route.ts` 调用
- 业务逻辑层（Application）
    - 新增 `src/application/usecases/*`：
        - `GenerateCardUseCase`：编排文案生成、卡片生成、缓存、限流
        - `ExportImagesUseCase`：校验、批量转图、压缩
    - 新增 `src/application/services/*`：面向用例的服务组合（非外部适配器）
- 数据访问层（Infrastructure）
    - 新增 `src/infrastructure/repositories/*`：`CacheRepository`、`RateLimiterRepository`、`RedisClient`
    - 新增 `src/infrastructure/providers/*`：`AIProviderDeepseek`、`AIProviderNanoBanana`（适配 `AIService` 抽象）
    - 统一外部 HTTP/SDK 适配器，隐藏实现细节
- 领域模型（Domain）
    - 新增 `src/domain/*`：核心类型与实体（`DesignJSON`、`GeneratedCard`、值对象、错误）
- 控制反转与依赖注入（IoC/DI）
    - 选择 `tsyringe` 轻量 DI（或无第三方以工厂+注册表实现），新增 `src/container/index.ts`
    - 约定 Token：`Logger`、`CacheRepository`、`RateLimiter`、`AIProvider`、`Config`
    - 请求作用域容器：路由入口创建子容器，注入 `requestId`、`clientIp` 等上下文

## 编码规范与代码质量

- ESLint/Prettier/TSC：
    - 强制导入排序、禁止未使用导入（已用 `eslint-plugin-unused-imports`），新增规则集与 `eslint-plugin-import`
    - 在 CI 中新增 `lint`、`typecheck` 步骤；PR 必须通过
- Git 流程：
    - 新增 PR 模板、分支保护、强制代码审查 ≥1 人
    - Husky `pre-commit` 已在仓库，补充 `typecheck` 与 `lint-staged` 校验
- 统一目录与命名：小写短横线目录，类型与接口统一命名约定（I 前缀仅限接口）

## 统一错误处理与日志

- 错误模型：新增 `src/domain/errors.ts` 定义 `AppError`（含 `code`、`httpStatus`、`safeMessage`）及子类
- 映射策略：API 层统一将 `AppError` 映射为 `jsonError`（参考 `src/lib/http.ts:11`），避免泄露内部细节
- 日志增强：
    - 在中间件生成 `requestId`，写入响应头与日志上下文（拓展 `src/lib/logger.ts:34` scope）
    - 结构化日志与敏感信息脱敏保留（现有 `redact` 已具备）
    - 可选接入 OpenTelemetry（traceId/metrics），或最小化埋点（时延、错误率）

## 测试体系（≥80% 覆盖）

- 单元测试：
    - 为 UseCase、Repository、Provider 补齐测试；使用 test doubles 隔离外部依赖
    - 为 API 路由的参数校验与错误映射补充测试
- 集成测试：
    - 以 Next Route Handler 为边界，覆蓋 Redis/Sharp/Playwright 的集成路径（配置可切换到内存/模拟）
- 端到端（E2E）：
    - Playwright 编写关键用户流（生成→预览→导出），利用已有依赖（`playwright`）
- 覆盖率：
    - Vitest `@vitest/coverage-v8` 设置阈值并在 CI Gate；上传覆盖率报告（延续 `.github/workflows/ci.yml:33`）
- 性能与安全测试：
    - 压测：`autocannon`/`k6` 针对 `generate`/`export` 端点做基准
    - 安全：`npm audit`、依赖漏洞扫描、基础 SSRF/注入单测、CORS/CSRF 校验（参考 `src/middleware.ts:20`）

## CI/CD 流程

- CI（GitHub Actions）：
    - 触发器：Push/PR 到 `main`
    - 阶段：`install` → `lint` → `typecheck` → `unit`（coverage gate）→ `build` → `e2e`（可选容器化）→ `artifact`
    - 缓存：`actions/setup-node@v4` + `npm ci` 缓存；Playwright 依赖安装与缓存
- CD：
    - 环境区分：`dev`/`staging`/`prod`；支持回滚策略（保留上一个构件）
    - 部署通道：若使用 Vercel，设置预览与生产；若自托管，提供 Dockerfile 与 Compose

## 性能优化

- 基线与监控：
    - 建立基准指标（P50/P95 延迟、TPS、错误率、内存占用）与跟踪面板
- 关键路径优化：
    - 生成流程：加速 SVG→PNG 路径，Playwright 渲染并发控制已存在（`src/shared/lib/image-converter.ts:39`），调优超时与并发
    - 缓存策略：
        - 请求级缓存（ETag/Cache-Control，参考 `src/app/api/generate/route.ts:72`）
        - 服务器端短期内存缓存 + Redis 共享缓存，统一键空间（`makeKey` 规范，`src/shared/lib/cache.ts:19`）
    - 可水平扩展：
        - 无状态路由 + Redis 共享；容器化部署，扩节点线性扩容

## 安全与合规

- 输入校验统一用 Zod（现已在路由使用，`src/app/api/generate/route.ts:22`）并在 UseCase 层复用
- 机密管理：禁止日志输出密钥（现有脱敏），环境变量 schema 校验（`src/config/index.ts:3`）
- 速率限制与防刷：统一由 `RateLimiter` 实现，按 IP/用户标识分桶（现有实现可复用）

## 迁移路线图（分阶段、可回滚）

- 阶段 0：基线与 CI 加固
    - 新增 `lint`/`typecheck`/`build` 任务与检查；PR 保护
- 阶段 1：引入容器与分层骨架
    - 建立 `domain`/`application`/`infrastructure`/`interfaces` 目录与最小可用骨架
    - 路由接入 `controllers`，保持对外接口不变
- 阶段 2：迁移核心用例
    - 将 `generate`、`export` 流程迁入 UseCase，`services` 变为 Provider
    - 补充单元/集成测试，覆盖率达 80%
- 阶段 3：错误与日志统一
    - `AppError` 全面落地；请求 ID 贯穿日志；观测指标上线
- 阶段 4：性能与缓存优化
    - 基准压测 → 针对瓶颈调优 → 复测出报告
- 阶段 5：灰度发布与回滚
    - `staging` 验证通过后，`prod` 灰度；保留上一版本构件与数据库/缓存回滚脚本

## 技术文档交付

- 架构设计文档：模块边界、依赖关系图、数据流、错误流
- API 文档：路由契约、请求/响应模型、错误码表
- 系统维护指南：环境变量、运行/调试、日志/监控、故障处置
- ADR：记录服务拆分、DI 引入、缓存策略、日志方案等关键决策

## 交付物

- 重构后的完整代码库（分层与 DI、统一错误与日志）
- 自动化测试套件（单元/集成/E2E，覆盖率报告≥80%）
- 技术文档包（架构、API、维护、ADR）
- 性能测试报告（基准与优化前后对比）

## 下一步（执行清单）

- 创建分层目录与 DI 容器骨架（不改变现有对外 API）
- 将 `generate`/`export` 路由迁移到 Controller+UseCase
- 增强 CI（lint/typecheck/build/e2e），设定覆盖率门槛
- 引入统一错误模型与请求 ID 日志
- 进行首次性能基准测试并出报告
