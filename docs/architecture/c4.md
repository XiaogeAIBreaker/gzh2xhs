# 架构设计文档 (C4 Model)

本文档采用 C4 模型描述 gzh2xhs 系统的软件架构。

## 1. Context View (系统上下文)

```mermaid
C4Context
    title System Context diagram for gzh2xhs

    Person(user, "User", "公众号运营者/内容创作者")
    System(gzh2xhs, "gzh2xhs System", "公众号转小红书卡片生成工具")
    
    System_Ext(wechat, "WeChat MP", "微信公众号文章源")
    System_Ext(llm, "LLM Service", "DeepSeek/NanoBanana AI API")
    System_Ext(xhs, "Xiaohongshu", "目标发布平台")

    Rel(user, gzh2xhs, "输入文章URL/文本，下载卡片", "HTTPS")
    Rel(gzh2xhs, wechat, "抓取/解析文章内容", "HTTPS")
    Rel(gzh2xhs, llm, "分析内容，生成摘要与设计JSON", "HTTPS")
    Rel(user, xhs, "上传卡片与文案", "App/Web")
```

## 2. Container View (容器视图)

```mermaid
C4Container
    title Container diagram for gzh2xhs

    Person(user, "User", "Web Browser")

    Container_Boundary(c1, "gzh2xhs Application") {
        Container(web_app, "Next.js App", "React, TypeScript, Tailwind", "提供 UI、BFF 与 API Routes")
        Container(api_nest, "API Service (NestJS)", "Node.js, NestJS", "核心业务逻辑、领域服务、复杂计算")
        Container(api_fastify, "API Service (Fastify)", "Node.js, Fastify", "高性能/轻量级 API (可选)")
        ContainerDb(redis, "Redis Cache", "Redis", "缓存 AI 结果、限流计数、幂等 Key")
        ContainerDb(db, "Primary DB", "PostgreSQL", "持久化用户数据、生成记录、配置")
    }

    System_Ext(llm, "LLM API", "External AI Service")

    Rel(user, web_app, "访问页面/调用 API", "HTTPS/JSON")
    Rel(web_app, api_nest, "RPC/HTTP 调用 (内部)", "HTTP")
    Rel(web_app, redis, "读取缓存", "TCP")
    Rel(api_nest, db, "读写数据", "TypeORM")
    Rel(api_nest, redis, "缓存/限流", "TCP")
    Rel(api_nest, llm, "请求 AI 生成", "HTTPS")
```

## 3. Component View (组件视图 - API Service)

```mermaid
C4Component
    title Component diagram for API Service (NestJS)

    Container(api, "API Service", "NestJS") {
        Component(controller, "GenerateController", "Controller", "接收生成请求，参数校验")
        Component(usecase, "GenerateCardUseCase", "UseCase", "编排生成流程：内容获取->AI分析->绘图")
        Component(domain_service, "AIService", "Domain Service", "封装 LLM 调用逻辑与 Prompt")
        Component(infra_img, "ImageConverter", "Infrastructure", "Playwright/Sharp 渲染 SVG 为 PNG")
        Component(repo, "RecordRepository", "Repository", "生成记录持久化")
    }

    Rel(controller, usecase, "Execute")
    Rel(usecase, domain_service, "Analyze Text")
    Rel(usecase, infra_img, "Render Image")
    Rel(usecase, repo, "Save Record")
```

## 4. 关键交互流程

### 卡片生成流程

1. **User** 提交文本/URL。
2. **Web App** 检查 Redis 缓存 (Cache-Aside)。
3. 若未命中，调用 **API Service**。
4. **GenerateUseCase** 并行执行：
   - 调用 **AIService** 获取摘要与设计 JSON。
   - 调用 **WeChatService** (若是URL) 解析正文。
5. **GenerateUseCase** 组合数据，调用 **ImageConverter** 生成图片。
6. 结果存入 **Redis** 并返回。
