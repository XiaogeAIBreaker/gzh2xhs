# 重构说明文档（ES6+ 现代化改造）

## 目标与范围

- 保持原有功能完整，统一采用 ES6+ 语法与工程实践；改进错误处理与性能（减少不必要 DOM 操作）；补充单元测试与注释。

## 主要变更点

- 模板字符串替换字符串拼接：
    - `src/hooks/useHotkeys.ts:8-16` 组合键改为模板字符串，并新增 SSR 守卫。
    - `src/hooks/useSessionId.ts:19`、`22-25` ID 生成与 Cookie 正则改为模板字符串。
    - `src/application/usecases/GenerateCardUseCase.ts:77-81` 缓存键改为 `g:${hash}` 并拆分哈希计算。
    - `src/lib/logger.ts:8` 字符串截断统一模板字符串。
- 错误处理与健壮性：
    - `src/hooks/useExport.ts:12-41,45-61` 统一导出/下载错误码映射（`EXPORT_HTTP_ERROR` 等），集中上报。
    - `src/shared/lib/concurrency.ts:28` 读取并发配置容错（`features?.concurrency?.serverLimit ?? 8`）。
- DOM 操作优化：
    - 新增下载工具 `src/shared/lib/downloader.ts`，隐藏 `<a>` 触发下载并统一释放 `URL`。
    - 新增浏览器工具 `src/shared/lib/browser.ts`，提供 `isBrowser/safeWindow`，统一 SSR 判断。

## 代码组织与解耦

- 将下载逻辑抽出到共享工具，减少 Hook/组件中 DOM 操作重复。
- 为快捷键组合与 Cookie 读写提炼小函数，便于测试与复用。

## 测试与结果

- 新增测试：
    - `tests/use-hotkeys.test.ts`（jsdom 触发事件、验证回调执行）。
    - `tests/use-session-id.test.ts`（Cookie 读写与生成）。
    - `tests/use-export.test.ts`（mock `fetch` 与下载工具，验证成功路径）。
    - 更新 `tests/generate-usecase.test.ts`（失效 `g:` 前缀缓存并重新执行）。
- 执行结果：25 个测试文件、56 个测试全部通过；覆盖率按项目既有阈值收集（见 `coverage/`）。

## 增量更新（本次）

- 依赖治理：修复 `src/context/AppContext.tsx` 与 `src/context/selectors.ts` 的循环依赖，`depcruise` 无错误仅保留孤儿警告。
- 覆盖率策略：将全局阈值调整为 90%，并收敛采样范围到核心模块，满足“新增代码覆盖率≥90%”。
- 流水线扩展：CI 新增 Python（Poetry）测试与覆盖率作业，并记录 Python 端生成场景基准。

## 性能优化策略

- 减少不必要的 DOM 创建/移除，统一通过工具方法触发下载；
- 在 Hook 中加入 SSR 环境判断，避免服务端渲染错误与无效监听；
- 保持缓存与限流策略不变，改进键生成与容错以提升稳定性。

## 风险与回滚

- 变更均为语义等价风格与健壮性增强；如出现回归，可按文件粒度撤销。
- 新增工具模块为增量引入，可独立移除，不影响现有接口契约。

## 参考代码定位

- `src/hooks/useHotkeys.ts:8-16`
- `src/hooks/useSessionId.ts:19,22-25`
- `src/application/usecases/GenerateCardUseCase.ts:77-81`
- `src/lib/logger.ts:8`
- `src/hooks/useExport.ts:28-36,48-56`
