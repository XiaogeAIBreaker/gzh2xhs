## 重构范围与目标

- 建立分层模块化架构的规范清单与落地脚手架，确保表现层/业务逻辑层/数据访问层边界清晰
- 统一 RESTful 接口契约（类型安全、错误模型、状态码、超媒体链接），完善 OpenAPI 文档
- 推进日志与观测体系（结构化日志、traceId 贯穿、指标/埋点统一）
- 完成性能与缓存方案（LRU+TTL、关键路径 100ms、99 线 <300ms），补齐基准测试
- 强化安全（输入/输出防护、JSON Schema 校验、RBAC 到 API 粒度、密钥轮换）
- 达成交付指标（覆盖率≥95%、SonarQube零严重、API文档100%、性能/安全报告）

## 待重构代码片段清单

- 统一错误响应模型
    - `src/lib/http.ts:13-22` 当前 `jsonError` 返回 `{ success, error, details }`；重构为 `{ code, message, fields, traceId }` 并强类型化
    - `src/middleware.ts:37-41` 403 响应采用统一错误模型并附带 `traceId`
    - `src/interfaces/http/controllers/GenerateController.ts:1-51` 与 `ExportController.ts:1-32` 所有 `jsonError/jsonOk` 调用统一错误与成功模型、精确状态码、携带 `traceId`
- OpenAPI 文档完善
    - `src/docs/openapi.ts:1-106` 为 4xx/5xx 响应增加 `application/json` 的错误模式 schema（`code/message/fields/traceId`），补齐 `/api/openapi`、`/api/track`、`/api/kpi` 的文档
- 日志追踪与结构化
    - `src/lib/logger.ts:23-39` 增加 `traceId` 字段；提供 `withContext({ traceId })` 生成子 logger；统一 `scope` 枚举
    - 所有控制器与中间件通过 `X-Request-Id` 传递 `traceId`；成功/错误日志输出包含 `traceId`
- 前端 Toast 组件可用性与代码美学
    - `src/components/Toast.tsx:15-59` 清理重复 `console.log` 调试输出；改为 4 空格缩进与语义化结构
    - 增强 a11y（`role="status"/aria-live="polite"`、可关闭、暂停计时、焦点管理），统一样式命名
- 缓存与性能
    - `src/shared/lib/cache.ts`（存在）：实现类型安全 LRU（O(1) get/put）+ TTL（动态配置），导出 `Cache<T>` 接口
    - 服务端关键路径：生成卡片（AI 双阶段）与导出 ZIP；在 `GenerateCardUseCase` 与 `ExportImagesUseCase` 增加缓存/短路逻辑与指标
- 安全与校验
    - 在 `src/types/schemas.ts` 与 API 层引入 JSON Schema（使用 `ajv`）；保留 `zod` 作为内部类型与静态检查，运行时走 JSON Schema
    - 新建 `src/interfaces/http/middleware/auth.ts` 与 `rbac.ts`：基于 `Authorization`/会话实现 RBAC，按操作粒度校验
    - 敏感信息加密存储（如需要写入持久层时）：抽象 `SecretStore` 接口，支持密钥轮换；现阶段配置走环境变量与 KMS 预留

## 架构与目录规范

- 表现层：`src/app/*`（Next.js 页面与 API Handler），`src/components/*`（UI）、`src/hooks/*`（交互）
- 业务层：`src/application/usecases/*`（用例）、`src/domain/*`（实体/服务接口）
- 接口层：`src/interfaces/http/*`（控制器/中间件/DTO）、`src/docs/*`（OpenAPI）
- 数据访问层：`src/infrastructure/repositories/*`（Redis/外部服务封装）、`src/shared/lib/*`（缓存/限流/日志/指标）
- 测试：每模块配套 `__tests__/*.test.ts`；集成测试放 `tests/*`

## RESTful 与成熟度模型（Level 3）

- 资源化路径与方法：`POST /api/generate`、`POST /api/export` 保持；新增资源自描述与状态转移
- 超媒体链接：成功响应返回 `links`（如 `self/generate/export/kpi`）；分页列表统一 `next/prev` 链接
- 错误模型：所有错误包含 `code/message/fields/traceId`；`code` 采用枚举并在文档中定义

## 代码美学与规范

- 样式工具：配置 `.editorconfig` 与 Prettier 使用 4 空格缩进、操作符两侧空格、方法间 2 行空行
- 命名：变量 `camelCase`、类 `PascalCase`、常量 `UPPER_CASE`；统一文件命名与导出风格
- 注释：公共 API 与复杂算法补充 JSDoc/思路说明（控制器、AI 双阶段解析等）

## 文档与示例

- OpenAPI：覆盖所有接口与错误模型，添加示例请求/响应
- 开发者示例：在 `src/examples/` 提供客户端调用示例与类型定义（Typed SDK）

## 测试与质量

- 单元测试：覆盖控制器/用例/缓存/日志，目标总覆盖率≥95%（`vitest run --coverage`）
- 端到端：`playwright` 覆盖核心流程（生成→预览→导出）
- 静态检查：`eslint`/`tsc` 零严重；集成 `sonar-scanner`（新增 `sonar-project.properties`）

## 性能与安全报告

- 性能基准：完善 `scripts/perf/*`，记录关键路径耗时分布与 99 线；加入缓存前后对比
- 安全渗透：在 CI 引入 OWASP ZAP 扫描，输出报告与修复项清单

## 变更清单（核心实现方向）

- 新增：`src/interfaces/http/middleware/{auth,rbac}.ts`、`src/types/errors.ts`、`src/examples/*`
- 修改：`http.ts`、`logger.ts`、`docs/openapi.ts`、各 `Controller`、`Toast.tsx`
- 配置：`.editorconfig`、Prettier/ESLint 规则更新、`sonar-project.properties`

## 依赖变更（谨慎引入）

- 运行时校验：`ajv`
- 可选：若缓存需求复杂可评估 `lru-cache`，当前优先自研轻量 LRU

## 交付与验收标准

- 测试覆盖率≥95%（含阈值守护）
- SonarQube 零严重缺陷（阻断规则启用）
- OpenAPI 文档完整且示例齐全
- 提供性能基准与安全渗透报告

请确认上述计划与待重构片段列表。确认后我将开始分批提交具体改造与对应测试、文档与报告。
