# 迁移与回滚机制

## 目标

- 无停机迁移至微服务与分布式数据库；可一键回滚。

## 方法

- Strangler Fig：API Gateway 按路由分流，新旧服务并行。
- 双写策略：关键表双写老库/新库，定期对账。
- 影子库压测：生产流量复制至影子库验证性能与一致性。
- 灰度发布：金丝雀 1%→5%→20%→100%，实时监控 SLO。

## 步骤

1. 建立数据迁移流水线（增量与全量），校验哈希与行数。
2. 启用读流迁移（只读实例），写保留在旧库；逐步切换写入。
3. 开启双写并比对差异，清理异常与补偿。
4. 观察期达标后，关闭旧写入口，切至新库主写。

## 回滚

- 触发条件：SLO 违反或错误预算耗尽；数据差异超阈值。
- 操作：API Gateway 回切旧服务；数据库写回滚至旧主；保留双写直至恢复。
- 文档：保留变更清单与操作剧本，执行前后审计记录。

## 验收

- 一致性：抽样与全量对账 100% 一致；
- 性能：P95 ≤ 200ms，QPS ≥ 10万；
- 可用性：≥ 99.99%；
- 安全：审计日志完整与不可篡改。
