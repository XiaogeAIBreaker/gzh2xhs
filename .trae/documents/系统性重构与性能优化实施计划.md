## 总览目标

- 建立清晰分层与依赖关系，职责单一，减少耦合，提升可维护性
- 针对关键路径（生成/导出/金融算法）进行性能优化与资源治理
- 统一错误模型与接口规范，增强模块协作的稳定性与复用性
- 完善异常防护与边界检查，确保在异常情形下可恢复与可降级
- 为复杂逻辑补充高质量注释/文档与测试，形成可审计的变更记录

## 架构与模块组织（训练计划：有层次的周期化）

- 明确分层
    - 接口层：`interfaces/http/*` 仅负责输入校验、RBAC、调用用例与构造响应
    - 应用层：`application/*` 负责编排用例流程与策略选择，不直接依赖具体服务实现
    - 领域层：`domain/*` 承载核心算法与领域错误；保持纯函数/可测试性
    - 基础设施层：`infrastructure/*` 适配外部系统（缓存、限流、AI 等）
    - 横切层：`shared/lib/*` 与 `lib/*` 提供工具、日志、指标、HTTP 等
- 依赖方向
    - `interfaces → application → domain`；`application → infrastructure`（通过接口/容器注入）
    - 收敛再导出路径，避免 `lib/*` 与 `shared/lib/*` 双轨并存
- 具体改造
    - 将应用层统一通过容器访问服务：`GenerateCardUseCase.execute`（src/application/usecases/GenerateCardUseCase.ts:30）从直接 `createAIService`（行 79）改为使用容器 `aiProvider.getService`
    - 收敛再导出文件：决定唯一入口为 `src/lib/*`，迁移实现至该目录或反向统一到 `shared/lib/*`
    - 增加架构依赖巡航与门禁：`dependency-cruiser` 配置规则确保依赖单向与分层约束

## 核心算法性能优化（训练：提升爆发力与效率）

- 图像渲染关键路径
    - 现状：`convertSvgToPng`（src/shared/lib/image-converter.ts:59）在并发控制处采用忙等轮询 `withLimit`（行 42）导致事件循环阻塞
    - 计划：引入轻量信号量/任务队列替换忙等；为 `sharp` 管线设置超时与内存上限；对回退策略分层，减少多次尝试的 CPU/内存压力
    - 输出限制：裁剪长日志与 SVG/PNG 体积，避免日志成为瓶颈
- AI 与文案并行
    - 现状：`GenerateCardUseCase.execute`（行 30-45）顺序执行文案与 AI 渲染
    - 计划：`makeCopytext`（行 66）与 `runAI`（行 73）并行执行，落地超时/重试/退避；超时返回占位图并异步补偿（接口返回 `pending` 标识）
- 限流与缓存
    - 现状：`createRateLimiter`（src/shared/lib/rateLimiter.ts:6）每次尝试 `ensureRedisConnected`（行 27），引入抖动
    - 计划：缓存连接状态与指数退避；标准化键空间（命名空间/剩余额度/重置时间返回）
- 指标/日志治理
    - 现状：`emit`（src/shared/lib/metrics.ts:22）每次调用都 `logger.info`，高 QPS 下日志成为开销
    - 计划：解耦导出器（stdout/Prometheus/Otel），支持批量/降采样；`summary`（行 47）维护分桶统计减少内存

## 模块协作与接口规范（训练：团队配合/战术纪律）

- 统一错误模型
    - 在领域层使用 `AppError`（`src/domain/errors.ts`）表达错误，应用/接口层统一映射为 `jsonError`（src/lib/http.ts:20）
    - 在控制器中不再手工拼业务字符串，统一捕获 `AppError` 并映射 code/message/status/fields/traceId
- 标准化控制器模板
    - 参考 `GenerateController.post`（src/interfaces/http/controllers/GenerateController.ts:12）抽象出控制器基类：封装开始时间/追踪/校验失败处理/成功响应/错误映射
    - 将 `getClientIp`（src/lib/http.ts:36）增强可信代理列表与更多头支持
- DI 与提供者
    - 统一通过 `AppContainer`（src/container/index.ts:9）注入 `AIProvider`、`CacheRepository`、`RateLimiterRepository`，用例层依赖容器接口而非具体实现

## 异常处理与边界防护（训练：运动防护）

- 接口层
    - `middleware`（src/middleware.ts:30）完善 CORS 白名单/通配配置，`X-Request-Id` 贯穿日志与指标；将 A/B 分配从中间件拆分为独立实验服务避免副作用
    - `requireAccess`（src/interfaces/http/middleware/rbac.ts:22）统一携带 `traceId` 与国际化错误信息；`parseAuth`（src/interfaces/http/middleware/auth.ts:5）支持 JWT 并做时效/权限校验
- 应用层
    - 为 `GenerateCardUseCase` 添加降级策略：限流触发返回明确 `429`；AI 超时返回占位图+提示；渲染失败走默认模板
- 图像/数据边界
    - `convertBase64ToPng`（src/shared/lib/image-converter.ts:152）与 `createTempImageUrl`（行 230）增加大小限制与格式校验；`validateImageQuality`（行 248）纳入响应前检查

## 注释文档与变更记录（训练：赛后复盘）

- 在以下文件补充模块头注释：设计意图、输入/输出、性能考量、错误语义、注意事项
    - `GenerateCardUseCase.ts`、`image-converter.ts`、`metrics.ts`、`rateLimiter.ts`、`lib/http.ts`、各 `Controller`
- 在 `docs/重构设计文档.md` 与 `.trae/documents/*` 形成结构图与依赖关系图（分层与数据流）
- 统一 CHANGELOG（遵循 Conventional Commits）与 `docs/变更影响分析报告.md` 更新

## 落地步骤与对应代码点

1. 搭建安全网测试

- 扩充 `vitest` 用例：
    - `tests/generate-usecase.test.ts`（行 44）新增并行执行与占位图降级场景
    - 为 `image-converter` 增加并发/超时/回退测试
    - 为 `rateLimiter` 增加 Redis 失联回退与滑动窗口校验

2. 错误模型统一

- 新增 `AppError → jsonError` 适配器，改造 `GenerateController.handleError`（src/interfaces/http/controllers/GenerateController.ts:65）与金融控制器

3. 性能优化

- 替换 `withLimit`（src/shared/lib/image-converter.ts:42）为信号量实现；为 `sharp` 流程加超时与内存上限；裁剪日志
- 将 `makeCopytext`（src/application/usecases/GenerateCardUseCase.ts:66）与 `runAI`（行 73）并行+超时重试

4. 接口规范与 DI

- 用例层使用 `AppContainer.aiProvider`（src/container/index.ts:9）取代 `createAIService`（src/services/index.ts:31）
- 收敛 `lib/*` 与 `shared/lib/*` 的导出路径，统一入口与命名

5. 文档与可观测性

- 增加 `metrics` 的导出器抽象；为关键指标提供 p95/p99 看板；补充模块注释与设计文档

## 验收标准

- 架构巡航规则通过（无越层依赖/环形依赖）
- p95 API 延迟下降（以 `api_generate_latency_ms` 为基线）
- 图像渲染在高并发下无事件循环阻塞；CPU 峰值降低
- 限流在 Redis 异常时无抖动并稳定回退；返回结构包含剩余额度与重置时间
- 错误语义统一（`AppError` → `jsonError`），控制器不再出现裸字符串错误逻辑
- 测试覆盖率提升，关键降级/回退路径具备回归用例

## 风险与回滚

- 涉及关键路径（渲染/AI/限流），将分支开发与灰度发布；出现问题可切换回旧策略实现（保留原始实现 1 个版本周期）

## 预计交付物

- 重构后的代码与测试
- 设计与变更文档（架构图/数据流/降级策略/错误语义）
- 基准与性能报告（前后对比、方法学说明）
